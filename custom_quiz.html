<!DOCTYPE html>
<html lang="en">

<head>
    <title>Custom Quiz Builder</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="quiz_common.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1a4d6e;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ‚îÄ Builder Panel ‚îÄ‚îÄ‚îÄ */
        #builder {
            position: fixed;
            left: 0;
            top: 0;
            width: 380px;
            height: 100vh;
            z-index: 1000;
            background: linear-gradient(180deg, #f0fdf4 0%, #e0f2f1 100%);
            border-right: 1px solid rgba(0, 137, 123, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.06);
        }

        .builder-header {
            padding: 24px 20px 16px;
            border-bottom: 1px solid rgba(0, 137, 123, 0.12);
        }

        .builder-header h1 {
            font-size: 22px;
            font-weight: 800;
            color: #00695c;
        }

        .builder-header p {
            color: #64748b;
            font-size: 13px;
            margin-top: 4px;
        }

        .builder-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .builder-body::-webkit-scrollbar {
            width: 4px;
        }

        .builder-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .builder-body::-webkit-scrollbar-thumb {
            background: rgba(0, 137, 123, 0.2);
            border-radius: 4px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            margin: 16px 0 10px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* ‚îÄ‚îÄ‚îÄ Step 1: Topic Selection (radio-style) ‚îÄ‚îÄ‚îÄ */
        .topic-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .topic-card:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(0, 137, 123, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .topic-card.selected {
            background: rgba(0, 137, 123, 0.08);
            border-color: rgba(0, 137, 123, 0.3);
        }

        .topic-card .tc-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topic-card .tc-radio {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .topic-card.selected .tc-radio {
            border-color: #00897b;
        }

        .topic-card .tc-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00897b;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .topic-card.selected .tc-dot {
            opacity: 1;
        }

        .topic-card .tc-name {
            font-size: 14px;
            font-weight: 600;
            color: #1a4d6e;
        }

        .topic-card .tc-count {
            font-size: 12px;
            color: #94a3b8;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.04);
            padding: 2px 8px;
            border-radius: 12px;
        }

        /* ‚îÄ‚îÄ‚îÄ Step 2: Mode Selection ‚îÄ‚îÄ‚îÄ */
        #step2 {
            display: none;
            margin-top: 16px;
        }

        .mode-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .mode-tab {
            flex: 1;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.6);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
        }

        .mode-tab:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .mode-tab.active {
            background: rgba(0, 137, 123, 0.1);
            border-color: rgba(0, 137, 123, 0.3);
            color: #00695c;
        }

        /* Random mode */
        #random-panel {
            display: none;
        }

        .q-count-section {
            padding: 16px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .q-count-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .q-count-label span {
            font-size: 14px;
            font-weight: 600;
            color: #1a4d6e;
        }

        .q-count-label .q-val {
            color: #00897b;
            font-weight: 800;
            font-size: 18px;
        }

        .q-range {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
        }

        .q-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00897b;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 137, 123, 0.3);
        }

        .q-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00897b;
            cursor: pointer;
            border: none;
        }

        .q-info {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 11px;
            color: #94a3b8;
        }

        /* Choose mode */
        #choose-panel {
            display: none;
        }

        .choose-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .choose-toolbar button {
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid rgba(0, 137, 123, 0.2);
            background: rgba(255, 255, 255, 0.7);
            color: #00897b;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .choose-toolbar button:hover {
            background: rgba(0, 137, 123, 0.1);
        }

        .choose-count {
            font-size: 12px;
            color: #64748b;
            margin-left: auto;
            font-weight: 600;
        }

        .choose-search {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.8);
            font-family: inherit;
            font-size: 13px;
            outline: none;
            margin-bottom: 10px;
        }

        .choose-search:focus {
            border-color: rgba(0, 137, 123, 0.3);
        }

        .q-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .q-list::-webkit-scrollbar {
            width: 4px;
        }

        .q-list::-webkit-scrollbar-thumb {
            background: rgba(0, 137, 123, 0.15);
            border-radius: 4px;
        }

        .q-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
            color: #334155;
        }

        .q-item:hover {
            background: rgba(0, 137, 123, 0.05);
        }

        .q-item input[type="checkbox"] {
            accent-color: #00897b;
            flex-shrink: 0;
        }

        .q-item.checked {
            color: #00695c;
            font-weight: 600;
        }

        /* Footer */
        .builder-footer {
            padding: 16px 20px;
            border-top: 1px solid rgba(0, 137, 123, 0.12);
        }

        .start-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(135deg, #00897b, #00695c);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 137, 123, 0.4);
        }

        .start-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .sel-summary {
            text-align: center;
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
        }

        /* ‚îÄ‚îÄ‚îÄ Map ‚îÄ‚îÄ‚îÄ */
        #map {
            margin-left: 380px;
            height: 100vh;
            background: #e3f2fd;
        }

        /* ‚îÄ‚îÄ‚îÄ Quiz Header ‚îÄ‚îÄ‚îÄ */
        #quiz-header {
            display: none;
            position: fixed;
            top: 0;
            left: 380px;
            right: 0;
            z-index: 900;
            padding: 12px 20px;
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .qh-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .qh-inner {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 10px 18px;
            font-weight: 700;
            color: #00695c;
        }

        .qh-question {
            flex: 2;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #004d40;
            line-height: 1.4;
        }

        .qh-question b {
            color: #d33a32;
            font-weight: 800;
            padding: 0 4px;
        }


        .qh-score {
            font-size: 14px;
            font-weight: 700;
            color: #00897b;
        }

        #timer {
            font-size: 13px;
            color: #00897b;
            margin-left: 10px;
            background: rgba(0, 137, 123, 0.1);
            padding: 4px 10px;
            border-radius: 6px;
        }

        /* Back button */
        .back-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1100;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
            color: #00897b;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }

        /* ‚îÄ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 800px) {
            #builder {
                width: 100%;
                height: auto;
                max-height: 50vh;
                position: relative;
                border-right: none;
                border-bottom: 1px solid rgba(0, 137, 123, 0.15);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }

            #map {
                margin-left: 0;
                height: 50vh;
            }

            #quiz-header {
                left: 0;
                padding: 8px 12px;
            }

            .qh-row {
                flex-wrap: wrap;
                gap: 6px;
            }

            .qh-inner {
                padding: 6px 12px;
                font-size: 13px;
            }

            .qh-question {
                order: -1;
                flex-basis: 100%;
                font-size: 15px;
            }

            .builder-header h1 {
                font-size: 18px;
            }

            .topic-card {
                padding: 8px 10px;
            }

            .topic-card .tc-name {
                font-size: 13px;
            }

            .back-btn {
                bottom: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div id="builder">
        <div class="builder-header">
            <h1>üõ†Ô∏è Custom Quiz Builder</h1>
            <p>Select a topic, then choose how to play</p>
        </div>
        <div class="builder-body" id="builder-body">
            <!-- Step 1: Topic list (built by JS) -->
            <div id="step1"></div>
            <!-- Step 2: Configure questions -->
            <div id="step2">
                <div class="section-title" id="step2-title">Configure Questions</div>
                <div class="mode-tabs">
                    <div class="mode-tab active" id="tab-random" onclick="switchMode('random')">üé≤ Random</div>
                    <div class="mode-tab" id="tab-choose" onclick="switchMode('choose')">üìù Choose</div>
                </div>
                <div id="random-panel" style="display:block;">
                    <div class="q-count-section">
                        <div class="q-count-label"><span>Questions</span><span class="q-val" id="q-val">10</span></div>
                        <input type="range" class="q-range" id="q-range" min="5" max="50" value="10" step="1">
                        <div class="q-info"><span>Min: 5</span><span id="q-max-label">Max: ‚Äî</span></div>
                    </div>
                </div>
                <div id="choose-panel">
                    <div class="choose-toolbar">
                        <button onclick="selectAllQuestions()">Select All</button>
                        <button onclick="deselectAllQuestions()">Clear</button>
                        <span class="choose-count" id="choose-count">0 selected</span>
                    </div>
                    <input type="text" class="choose-search" id="choose-search" placeholder="Search questions‚Ä¶"
                        oninput="filterQuestions()">
                    <div class="q-list" id="q-list"></div>
                </div>
            </div>
        </div>
        <div class="builder-footer">
            <button class="start-btn" id="start-btn" disabled>Start Quiz</button>
            <div class="sel-summary" id="sel-summary">Select a topic to begin</div>
        </div>
    </div>

    <div id="quiz-header">
        <div class="qh-row">
            <div class="qh-inner"><span class="qh-score" id="score-text">Score: 0%</span></div>
            <div class="qh-inner qh-question" id="question">Loading...</div>
            <div class="qh-inner"><span id="timer"></span></div>
        </div>
    </div>

    <div id="map"></div>
    <a href="index.html" class="back-btn">‚Üê Back</a>

    <script>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           TOPIC REGISTRY
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        const TOPICS = [
            { id: 'countries', name: 'World Countries', file: 'world_countries.geojson', type: 'geojson-poly', count: 179 },
            { id: 'oceans', name: 'Oceans & Seas', file: 'world_oceans.geojson', type: 'geojson-poly', count: 101 },
            { id: 'rivers', name: 'World Rivers', file: 'world_rivers.geojson', type: 'geojson-line', count: 100 },
            { id: 'capitals', name: 'World Capitals', file: 'world_capitals.csv', type: 'csv-marker', count: 195 },
            { id: 'mountains', name: 'Mountain Peaks', file: 'world_mountain_peaks.csv', type: 'csv-marker', count: 30 },
            { id: 'lakes', name: 'World Lakes', file: 'world_lakes.csv', type: 'csv-marker', count: 40 },
            { id: 'volcanoes', name: 'Active Volcanoes', file: 'world_active_volcanos.csv', type: 'csv-marker', count: 30 },
            { id: 'waterfalls', name: 'World Waterfalls', file: 'world_waterfalls.csv', type: 'csv-marker', count: 30 },
            { id: 'ca_world', name: 'Current Affairs ‚Äî World', file: 'current_affairs_world.csv', type: 'csv-marker', count: 96 },
            { id: 'ca_india', name: 'Current Affairs ‚Äî India', file: 'current_affairs_india.csv', type: 'csv-marker', count: 47 },
        ];

        let selectedTopic = null;
        let loadedItems = [];          // all parsed items for the selected topic
        let selectedQuestions = new Set(); // indices of manually-picked questions
        let questionCount = 10;
        let currentMode = 'random';    // 'random' or 'choose'

        /* ‚îÄ‚îÄ‚îÄ MAP SETUP ‚îÄ‚îÄ‚îÄ */
        const worldBounds = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
        const map = L.map('map', { maxBoundsViscosity: 1.0, maxBounds: worldBounds }).setView([20, 0], 2);
        map.createPane('ripplePane');
        map.getPane('ripplePane').style.zIndex = 700;
        map.getPane('ripplePane').style.pointerEvents = 'none';

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© Esri', maxZoom: 9, minZoom: 2, noWrap: true, bounds: worldBounds
        }).addTo(map);

        fetch("world_countries.geojson").then(r => r.json()).then(data => {
            L.geoJSON(data, { style: { color: "#9e9e9e", weight: 0.8, fillColor: "#e8e8e8", fillOpacity: 0.2 } }).addTo(map);
        }).catch(() => { });

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           STEP 1: BUILD TOPIC LIST
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function buildTopicList() {
            const container = document.getElementById('step1');
            container.innerHTML = '<div class="section-title">Choose a Topic</div>';
            TOPICS.forEach(topic => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.setAttribute('data-id', topic.id);
                card.innerHTML = `
                    <div class="tc-left">
                        <div class="tc-radio"><div class="tc-dot"></div></div>
                        <span class="tc-name">${topic.name}</span>
                    </div>
                    <span class="tc-count">${topic.count}</span>
                `;
                card.addEventListener('click', () => selectTopic(topic.id, card));
                container.appendChild(card);
            });
        }
        buildTopicList();

        /* ‚îÄ‚îÄ‚îÄ Clear previous quiz state ‚îÄ‚îÄ‚îÄ */
        function clearQuizState() {
            stopTimer();
            // remove all quiz layers from map
            itemLayers.forEach(entry => {
                entry.layers.forEach(layer => { map.removeLayer(layer); });
            });
            itemLayers = [];
            quizQueue = [];
            currentItem = null;
            totalQ = 0;
            correctCount = 0;
            attemptsTotal = 0;
            attemptsLeft = 3;
            document.getElementById('quiz-header').style.display = 'none';
            document.getElementById('score-text').textContent = 'Score: 0%';
            document.getElementById('timer').textContent = '';
            document.getElementById('question').textContent = 'Loading...';
            document.getElementById('start-btn').textContent = 'Start Quiz';
            document.getElementById('start-btn').disabled = false;
            /* restore builder on mobile */
            document.getElementById('builder').style.display = '';
            document.getElementById('map').style.height = '';
        }

        async function selectTopic(id, card) {
            clearQuizState();
            // deselect previous
            document.querySelectorAll('.topic-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedTopic = TOPICS.find(t => t.id === id);

            // load data
            document.getElementById('sel-summary').textContent = 'Loading ' + selectedTopic.name + '‚Ä¶';
            try {
                const resp = await fetch(selectedTopic.file);
                loadedItems = [];
                if (selectedTopic.type === 'csv-marker') {
                    const text = await resp.text();
                    loadedItems = parseCSVToItems(text, selectedTopic.id);
                } else if (selectedTopic.type === 'geojson-poly') {
                    const data = await resp.json();
                    data.features.forEach(f => {
                        const name = f.properties.name || f.properties.NAME || f.properties.Name || '';
                        if (name) loadedItems.push({ name: name.trim(), type: 'poly', feature: f, topicId: selectedTopic.id });
                    });
                } else if (selectedTopic.type === 'geojson-line') {
                    const data = await resp.json();
                    const groups = {};
                    data.features.forEach(f => { const n = (f.properties.name || '').trim(); if (n) { if (!groups[n]) groups[n] = []; groups[n].push(f); } });
                    Object.entries(groups).forEach(([name, features]) => {
                        loadedItems.push({ name, type: 'line', features, topicId: selectedTopic.id });
                    });
                }
            } catch (e) { console.error(e); document.getElementById('sel-summary').textContent = 'Error loading data.'; return; }

            // Show step 2
            document.getElementById('step2').style.display = 'block';
            document.getElementById('step2-title').textContent = selectedTopic.name + ' ‚Äî Configure';

            // Update slider
            const slider = document.getElementById('q-range');
            slider.max = loadedItems.length;
            slider.min = 1;
            questionCount = Math.min(questionCount, loadedItems.length);
            slider.value = questionCount;
            document.getElementById('q-val').textContent = questionCount;
            document.getElementById('q-max-label').textContent = 'Max: ' + loadedItems.length;

            // Build checklist
            buildQuestionList();
            selectedQuestions.clear();
            updateChooseCount();
            updateFooter();
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           STEP 2: MODE SWITCHING
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('tab-random').classList.toggle('active', mode === 'random');
            document.getElementById('tab-choose').classList.toggle('active', mode === 'choose');
            document.getElementById('random-panel').style.display = mode === 'random' ? 'block' : 'none';
            document.getElementById('choose-panel').style.display = mode === 'choose' ? 'block' : 'none';
            updateFooter();
        }

        // Slider
        document.getElementById('q-range').addEventListener('input', (e) => {
            questionCount = parseInt(e.target.value);
            document.getElementById('q-val').textContent = questionCount;
            updateFooter();
        });

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           CHOOSE MODE: Question Checklist
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function buildQuestionList() {
            const list = document.getElementById('q-list');
            list.innerHTML = '';
            loadedItems.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'q-item';
                div.setAttribute('data-idx', idx);
                div.setAttribute('data-name', item.name.toLowerCase());
                div.innerHTML = `<input type="checkbox" /><span>${item.name}</span>`;
                div.addEventListener('click', (e) => {
                    const cb = div.querySelector('input');
                    if (e.target !== cb) cb.checked = !cb.checked;
                    if (cb.checked) { selectedQuestions.add(idx); div.classList.add('checked'); }
                    else { selectedQuestions.delete(idx); div.classList.remove('checked'); }
                    updateChooseCount();
                    updateFooter();
                });
                list.appendChild(div);
            });
        }

        function filterQuestions() {
            const term = document.getElementById('choose-search').value.toLowerCase();
            document.querySelectorAll('.q-item').forEach(div => {
                div.style.display = div.getAttribute('data-name').includes(term) ? '' : 'none';
            });
        }

        function selectAllQuestions() {
            document.querySelectorAll('.q-item').forEach(div => {
                if (div.style.display === 'none') return;
                const idx = parseInt(div.getAttribute('data-idx'));
                const cb = div.querySelector('input');
                cb.checked = true; div.classList.add('checked');
                selectedQuestions.add(idx);
            });
            updateChooseCount(); updateFooter();
        }

        function deselectAllQuestions() {
            selectedQuestions.clear();
            document.querySelectorAll('.q-item').forEach(div => {
                div.querySelector('input').checked = false; div.classList.remove('checked');
            });
            updateChooseCount(); updateFooter();
        }

        function updateChooseCount() {
            document.getElementById('choose-count').textContent = selectedQuestions.size + ' selected';
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           FOOTER STATE
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function updateFooter() {
            const btn = document.getElementById('start-btn');
            const summary = document.getElementById('sel-summary');
            if (!selectedTopic) { btn.disabled = true; summary.textContent = 'Select a topic to begin'; return; }

            if (currentMode === 'random') {
                btn.disabled = false;
                summary.textContent = selectedTopic.name + ' ¬∑ ' + questionCount + ' random questions';
            } else {
                btn.disabled = selectedQuestions.size === 0;
                summary.textContent = selectedTopic.name + ' ¬∑ ' + selectedQuestions.size + ' questions chosen';
            }
        }

        document.getElementById('start-btn').addEventListener('click', startCustomQuiz);

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           START QUIZ
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function startCustomQuiz() {
            initAudio();
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').textContent = 'Starting‚Ä¶';

            let items;
            if (currentMode === 'choose') {
                items = [...selectedQuestions].map(i => loadedItems[i]);
            } else {
                // Random: shuffle and take N
                const shuffled = [...loadedItems];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                items = shuffled.slice(0, questionCount);
            }

            // Deduplicate by name
            const seen = new Set();
            items = items.filter(item => { if (seen.has(item.name)) return false; seen.add(item.name); return true; });

            launchQuiz(items);
        }

        /* ‚îÄ‚îÄ‚îÄ CSV Parser ‚îÄ‚îÄ‚îÄ */
        function parseCSVToItems(text, topicId) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const items = [];
            for (let i = 1; i < lines.length; i++) {
                const parts = smartSplit(lines[i]);
                const obj = {}; headers.forEach((h, idx) => { obj[h] = (parts[idx] || '').trim(); });
                const name = obj.NAME || obj.name || obj.Name || obj.QUESTION || '';
                const lat = parseFloat(obj.LATITUDE || obj.latitude || obj.LAT || obj.lat || 0);
                const lng = parseFloat(obj.LONGITUDE || obj.longitude || obj.LNG || obj.lng || obj.LON || 0);
                if (name && !isNaN(lat) && !isNaN(lng)) items.push({ name: name.trim(), lat, lng, type: 'marker', topicId, comment: obj.COMMENT || '' });
            }
            return items;
        }
        function smartSplit(line) { const p = []; let c = '', q = false; for (let i = 0; i < line.length; i++) { if (line[i] === '"') { q = !q; continue; } if (line[i] === ',' && !q) { p.push(c.trim()); c = ''; continue; } c += line[i]; } p.push(c.trim()); return p; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUIZ ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        let quizQueue = [], currentItem = null, totalQ = 0, correctCount = 0, attemptsTotal = 0, attemptsLeft = 3;
        let itemLayers = [];

        const DP = { color: '#3b82f6', weight: 1.5, fillColor: '#3b82f6', fillOpacity: 0.15 };
        const HP = { color: '#60a5fa', weight: 2.5, fillColor: '#60a5fa', fillOpacity: 0.25 };
        const CP = { color: '#1e9d46', weight: 3, fillColor: '#1e9d46', fillOpacity: 0.35 };
        const WP = { color: '#d33a32', weight: 3, fillColor: '#d33a32', fillOpacity: 0.35 };
        const XP = { color: '#9e9e9e', weight: 1, fillColor: '#9e9e9e', fillOpacity: 0.08 };

        const DL = { color: '#0097a7', weight: 2.5, opacity: 0.7 };
        const HL = { color: '#00bcd4', weight: 4, opacity: 1 };
        const CL = { color: '#1e9d46', weight: 5, opacity: 1 };
        const WL = { color: '#d33a32', weight: 5, opacity: 1 };
        const XL = { color: '#9e9e9e', weight: 1.5, opacity: 0.3 };

        const MICON = '<div style="width:12px;height:12px;border-radius:50%;background:#0097a7;border:2px solid rgba(255,255,255,0.7);box-shadow:0 0 6px rgba(0,151,167,0.4);"></div>';
        const MHOVER = '<div style="width:16px;height:16px;border-radius:50%;background:#00bcd4;border:2px solid rgba(255,255,255,0.8);box-shadow:0 0 10px rgba(0,188,212,0.5);"></div>';
        const MCORRECT = '<div style="width:14px;height:14px;border-radius:50%;background:#1e9d46;border:2px solid rgba(255,255,255,0.8);box-shadow:0 0 8px rgba(30,157,70,0.5);"></div>';
        const MWRONG = '<div style="width:14px;height:14px;border-radius:50%;background:#d33a32;border:2px solid rgba(255,255,255,0.8);"></div>';

        function mkIcon(html, sz) { return L.divIcon({ html, className: '', iconSize: [sz, sz], iconAnchor: [sz / 2, sz / 2] }); }

        function launchQuiz(items) {
            document.getElementById('quiz-header').style.display = 'block';
            /* on mobile, hide builder so map + header fill screen */
            if (window.innerWidth <= 800) {
                document.getElementById('builder').style.display = 'none';
                document.getElementById('map').style.height = '100vh';
            }
            items.forEach((item, idx) => {
                const entry = { item, layers: [] };
                if (item.type === 'marker') {
                    const marker = L.marker([item.lat, item.lng], { icon: mkIcon(MICON, 12) }).addTo(map);
                    marker.on('click', () => handleAnswer(idx));
                    marker.on('mouseover', () => { if (!entry._done) marker.setIcon(mkIcon(MHOVER, 16)); });
                    marker.on('mouseout', () => { if (!entry._done) marker.setIcon(mkIcon(MICON, 12)); });
                    entry.layers.push(marker);
                } else if (item.type === 'poly') {
                    const layer = L.geoJSON(item.feature, { style: DP }).addTo(map);
                    layer.eachLayer(l => { l.on('mouseover', () => { if (!entry._done) l.setStyle(HP); }); l.on('mouseout', () => { if (!entry._done) l.setStyle(DP); }); l.on('click', () => handleAnswer(idx)); });
                    entry.layers.push(layer);
                } else if (item.type === 'line') {
                    item.features.forEach(f => {
                        const layer = L.geoJSON(f, { style: DL }).addTo(map);
                        layer.eachLayer(l => { l.on('mouseover', () => { if (!entry._done) setStyle(entry, HL); }); l.on('mouseout', () => { if (!entry._done) setStyle(entry, DL); }); l.on('click', () => handleAnswer(idx)); });
                        entry.layers.push(layer);
                    });
                }
                itemLayers.push(entry);
            });
            quizQueue = items.map((_, i) => i);
            totalQ = quizQueue.length;
            startTimer();
            nextQuestion();
        }

        function setStyle(entry, style) { entry.layers.forEach(l => { if (l.eachLayer) l.eachLayer(sub => { if (sub.setStyle) sub.setStyle(style); }); }); }

        function handleAnswer(clickedIdx) {
            const entry = itemLayers[clickedIdx];
            if (entry._done) return;
            const currentIdx = quizQueue[0];
            attemptsTotal++;

            if (clickedIdx === currentIdx) {
                correctCount++; playCorrectSound(); updateScore();
                entry._done = true;
                const item = entry.item;
                if (item.type === 'marker') {
                    entry.layers[0].setIcon(mkIcon(MCORRECT, 14));
                    triggerCelebration([item.lat, item.lng]);
                    setTimeout(() => { entry.layers[0].setOpacity(0.3); quizQueue.shift(); nextQuestion(); }, 2500);
                } else if (item.type === 'poly') {
                    setStyle(entry, CP); const b = entry.layers[0].getBounds(); triggerCelebration(b.getCenter());
                    setTimeout(() => { setStyle(entry, XP); quizQueue.shift(); nextQuestion(); }, 2500);
                } else if (item.type === 'line') {
                    setStyle(entry, CL); const b = entry.layers[0].getBounds(); triggerCelebration(b.getCenter());
                    setTimeout(() => { setStyle(entry, XL); quizQueue.shift(); nextQuestion(); }, 2500);
                }
                return;
            }

            playIncorrectSound(); updateScore(); attemptsLeft--;
            const wi = entry.item;
            if (wi.type === 'poly') { setStyle(entry, WP); setTimeout(() => setStyle(entry, DP), 1200); }
            else if (wi.type === 'line') { setStyle(entry, WL); setTimeout(() => setStyle(entry, DL), 1200); }
            else { entry.layers[0].setIcon(mkIcon(MWRONG, 14)); setTimeout(() => entry.layers[0].setIcon(mkIcon(MICON, 12)), 1200); }

            if (attemptsLeft <= 0) {
                const ce = itemLayers[currentIdx]; ce._done = true;
                const ci = ce.item;
                if (ci.type === 'poly') { setStyle(ce, WP); triggerRippleAt(ce.layers[0].getBounds().getCenter(), '#d33a32'); }
                else if (ci.type === 'line') { setStyle(ce, WL); triggerRippleAt(ce.layers[0].getBounds().getCenter(), '#d33a32'); }
                else { ce.layers[0].setIcon(mkIcon(MWRONG, 18)); map.flyTo([ci.lat, ci.lng], Math.max(map.getZoom(), 5), { duration: 0.6 }); triggerRippleAt([ci.lat, ci.lng], '#d33a32'); }
                setTimeout(() => {
                    if (ci.type === 'poly') setStyle(ce, XP);
                    else if (ci.type === 'line') setStyle(ce, XL);
                    else ce.layers[0].setOpacity(0.3);
                    quizQueue.shift(); nextQuestion();
                }, 3000);
            }
        }

        function nextQuestion() {
            attemptsLeft = 3;
            if (quizQueue.length === 0) { endQuiz(); return; }
            const idx = quizQueue[0];
            const qNum = totalQ - quizQueue.length + 1;
            setQuestion(currentItem.name, qNum, totalQ);
        }

        function updateScore() {
            const pct = attemptsTotal === 0 ? 0 : Math.round((correctCount / attemptsTotal) * 100);
            document.getElementById('score-text').textContent = 'Score: ' + pct + '%';
        }

        function endQuiz() {
            stopTimer();
            const pct = attemptsTotal === 0 ? 0 : Math.round((correctCount / attemptsTotal) * 100);
            document.getElementById('question').innerHTML = 'Quiz Complete! <b>' + pct + '%</b> ‚Äî ' + correctCount + '/' + totalQ + ' correct';
            const btn = document.createElement('button');
            btn.textContent = 'Build Another';
            btn.style.cssText = 'margin-left:12px;padding:5px 14px;border-radius:8px;border:1px solid #00897b;background:#fff;color:#00897b;cursor:pointer;font-weight:700;';
            btn.onclick = () => location.reload();
            document.getElementById('question').appendChild(btn);
        }
    </script>
</body>

</html>