<!DOCTYPE html>
<html>
<head>
    <title>India Districts Quiz</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial; text-align: center; margin: 0; padding: 0; }
        
        /* State Selection Screen */
        #state-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .state-selection-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        
        .state-selection-box h1 {
            margin: 0 0 20px 0;
            font-size: 28px;
            color: #333;
        }
        
        .state-selection-box p {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .state-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .state-btn {
            padding: 12px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .state-btn:hover {
            background: #e0e0e0;
            border-color: #999;
        }
        
        .state-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }
        
        .start-btn {
            margin-top: 20px;
            padding: 12px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }
        
        .start-btn:hover {
            background: #45a049;
        }
        
        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Quiz Screen */
        #quiz-container {
            display: none;
        }
        
        /* overlays sit above the map */
        #map-overlays { position: relative; height: 64px; }
        #map { height: 600px; margin-top: 8px; background: #f4f4f4; }
        .overlay { position: absolute; z-index: 400; padding: 6px 10px; background: rgba(255,255,255,0.95); border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: 600; }
        .top-left { left: 8px; top: 8px; }
        .top-right { right: 8px; top: 8px; }
        .center-top { left: 50%; top: 8px; transform: translateX(-50%); font-size: 20px; }
        #question { font-size: 18px; }
        #score { font-size: 16px; }
    </style>
</head>
<body>

<!-- State Selection Screen -->
<div id="state-selection">
    <div class="state-selection-box">
        <h1>Select a State</h1>
        <p>Choose a state to quiz on its districts:</p>
        <div class="state-grid" id="state-grid"></div>
        <button class="start-btn" id="start-btn" disabled>Start Quiz</button>
    </div>
</div>

<!-- Quiz Screen -->
<div id="quiz-container">
    <div id="map-overlays">
        <div class="overlay top-left">Quiz : Districts</div>
        <div id="score" class="overlay top-right"><span id="score-text">Score: 0%</span> <span id="timer" style="margin-left:12px;font-weight:400;font-size:15px;"></span></div>
        <div id="question" class="overlay center-top">Loading...</div>
    </div>
    <div id="map"></div>
</div>

<script>

let allData = null;
let filteredDistricts = [];
let selectedState = null;
let map = null;

let districts = [];
let currentDistrict = "";
let totalQuestions = 0;
let correctAnswers = 0;
let geoLayer;
let maxQuestions = 0;
let attemptsLeft = 3;
let attemptsCount = 0;
let requireCorrectToAdvance = false;
let correctLayerForCurrent = null;

// Load the GeoJSON
fetch("india_districts.geojson")
.then(response => response.json())
.then(data => {
    allData = data;
    populateStateSelection();
})
.catch(err => {
    alert("Error loading GeoJSON: " + err);
});

function populateStateSelection() {
    if (!allData || !allData.features) return;
    
    // Extract unique states
    const stateSet = new Set();
    allData.features.forEach(feature => {
        const state = feature.properties && feature.properties.st_nm;
        if (state) stateSet.add(state);
    });
    
    const states = Array.from(stateSet).sort();
    const stateGrid = document.getElementById("state-grid");
    stateGrid.innerHTML = "";
    
    states.forEach(state => {
        const btn = document.createElement("button");
        btn.textContent = state;
        btn.className = "state-btn";
        btn.onclick = () => selectState(state, btn);
        stateGrid.appendChild(btn);
    });
}

function selectState(state, btn) {
    // Deselect previous selection
    document.querySelectorAll(".state-btn").forEach(b => b.classList.remove("selected"));
    
    // Select current state
    selectedState = state;
    btn.classList.add("selected");
    
    // Enable start button
    document.getElementById("start-btn").disabled = false;
}

document.getElementById("start-btn").onclick = function() {
    if (!selectedState) return;
    
    // Filter districts by selected state
    filteredDistricts = allData.features.filter(f => 
        f.properties && f.properties.st_nm === selectedState
    );
    
    if (filteredDistricts.length === 0) {
        alert("No districts found for " + selectedState);
        return;
    }
    
    // Hide state selection, show quiz
    document.getElementById("state-selection").style.display = "none";
    document.getElementById("quiz-container").style.display = "block";
    
    // Initialize quiz
    initializeQuiz();
};

function initializeQuiz() {
    // Create map
    map = L.map('map').setView([22, 80], 5);
    
    districts = filteredDistricts.map(f => f.properties.district);
    maxQuestions = Math.min(districts.length, 30);

    
    geoLayer = L.geoJSON(filteredDistricts, {
        style: {
            color: "black",
            weight: 1,
            fillColor: "#cccccc",
            fillOpacity: 0.6
        },
        onEachFeature: function (feature, layer) {
            layer.on({
                mouseover: function (e) {
                    layer.setStyle({ weight: 2, color: '#666' });
                },
                mouseout: function (e) {
                    geoLayer.resetStyle(layer);
                },
                click: function (e) {
                    const districtName = feature && feature.properties && feature.properties.district;
                    
                    // increment attempts count (used for scoring)
                    attemptsCount++;

                    if (districtName === currentDistrict) {
                        // Correct: show green for 2s
                        correctAnswers++;
                        updateScore();
                        layer.setStyle({ fillColor: 'green' });
                        setTimeout(() => {
                            geoLayer.resetStyle(layer);
                            nextQuestion();
                        }, 2000);

                    } else {
                        // Incorrect: decrement attempts
                        updateScore();
                        attemptsLeft = Math.max(0, attemptsLeft - 1);
                        if (attemptsLeft > 0) {
                            // red for 2s on the clicked (wrong) layer
                            layer.setStyle({ fillColor: 'red' });
                            setTimeout(() => geoLayer.resetStyle(layer), 2000);
                        } else {
                            // after 3 consecutive wrong tries: show correct layer by flickering it for 3s
                            let correctLayer = null;
                            geoLayer.eachLayer(function (lyr) {
                                const nm = lyr.feature && lyr.feature.properties && lyr.feature.properties.district;
                                if (nm === currentDistrict) correctLayer = lyr;
                            });
                            if (correctLayer) {
                                let on = true;
                                const orig = correctLayer.options.fillColor || '#cccccc';
                                const iv = setInterval(() => {
                                    correctLayer.setStyle({ fillColor: on ? 'red' : orig });
                                    on = !on;
                                }, 250);
                                setTimeout(() => {
                                    clearInterval(iv);
                                    geoLayer.resetStyle(correctLayer);
                                    // Do NOT auto-advance; require the user to click the correct district to continue
                                    requireCorrectToAdvance = true;
                                    correctLayerForCurrent = correctLayer;
                                    // visually indicate the correct target (outline)
                                    try { correctLayer.setStyle({ weight: 3, color: '#2a7fff' }); } catch(e) {}
                                    // update the prompt to make the requirement clear
                                    const q = document.getElementById('question');
                                    if (q) q.innerHTML = "Click on: <b>" + currentDistrict + "</b> (click the correct district to continue)";
                                }, 3000);
                            } else {
                                // fallback: if we can't locate the correct layer, advance
                                nextQuestion();
                            }
                        }
                        // show a short tooltip with the clicked district's name at the click location
                        let tooltipContent = districtName || 'Unknown';
                        layer.bindTooltip(tooltipContent, {
                            permanent: false,
                            className: 'wrong-tooltip',
                            direction: 'top',
                            offset: [0, -10]
                        }).openTooltip(e && e.latlng ? e.latlng : undefined);
                        setTimeout(()=> layer.closeTooltip(), 1200);
                    }
                }
            });
        }
    }).addTo(map);

    // Fit to GeoJSON bounds for a better initial view
    try { map.fitBounds(geoLayer.getBounds()); } catch(e) { }

    startTimer();
    nextQuestion();
}

function nextQuestion() {

    // Clear any 'must click correct to advance' state from previous question
    requireCorrectToAdvance = false;
    if (correctLayerForCurrent) {
        try { geoLayer.resetStyle(correctLayerForCurrent); } catch(e) {}
        correctLayerForCurrent = null;
    }

    // If maxQuestions is set and we've already asked that many, finish
    if (maxQuestions > 0 && totalQuestions >= maxQuestions) {
        endQuiz();
        return;
    }

    if (!districts || districts.length === 0) {
        endQuiz();
        return;
    }

    // Pick a random district and remove it from the pool to avoid repeats
    const idx = Math.floor(Math.random() * districts.length);
    currentDistrict = districts.splice(idx, 1)[0];

    // reset attempts for this question
    attemptsLeft = 3;

    totalQuestions++;

    document.getElementById("question").innerHTML =
        "Click on: <b>" + currentDistrict + "</b>";
}

function updateScore() {
    // Score = correct clicks / total clicks (attempts)
    let percentage = attemptsCount === 0 ? 0 : Math.round((correctAnswers / attemptsCount) * 100);
    document.getElementById("score-text").innerHTML =
        "Score: " + percentage + "%";
}

// Timer logic
let timerInterval = null;
let startTime = null;
function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
}
function updateTimer() {
    if (!startTime) return;
    const now = Date.now();
    const elapsed = Math.floor((now - startTime) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    document.getElementById("timer").textContent =
        "Time: " + mins + ":" + (secs < 10 ? "0" : "") + secs;
}
function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
}

function endQuiz() {
    stopTimer();
    const percent = attemptsCount === 0 ? 0 : Math.round((correctAnswers / attemptsCount) * 100);
    document.getElementById("question").innerHTML =
        "Quiz finished! Final score: <b>" + percent + "%</b>";

    // Disable interactions on all layers
    if (geoLayer) {
        geoLayer.eachLayer(function (layer) {
            layer.off();
        });
    }

    // Optionally show restart control
    const restart = document.createElement('button');
    restart.textContent = 'Restart Quiz';
    restart.style.marginLeft = '10px';
    restart.onclick = function () { location.reload(); };
    const q = document.getElementById('question');
    if (q) q.appendChild(restart);
}

</script>

</body>
</html>